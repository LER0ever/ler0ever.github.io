<!doctype html><html lang=en><title>Closer Look to WSL - L.E.R Space</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=Keywords content="LER0ever,L.E.R,Yi Rong,blog,L.E.R Space,Portus"><meta name=Description content><link rel=manifest href=/manifest.json><link rel="shortcut icon" href=/favicon.ico><script>if(self!=top){top.location=this.location.href;}</script><link rel=stylesheet href=/css/bundle.css><link rel=stylesheet href=/css/hody-icons.css><link rel=stylesheet href=/css/hljs-dracula.css><link rel=stylesheet href=/css/style.css><link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600|Source+Sans+Pro:300,400|Lora|Damion:400" rel=stylesheet><link rel=stylesheet href=/search/css/search.css><div id=loader><div class=centrize><div class=v-center><div id=mask><svg class="preloader-icon" width="34" height="38" viewbox="0 0 34 38"><path class="preloader-path" stroke-dashoffset="0" d="M29.437 8.114 19.35 2.132c-1.473-.86-3.207-.86-4.68.0L4.153 8.114C2.68 8.974 1.5 10.56 1.5 12.28v11.964c0 1.718 1.22 3.306 2.69 4.165l10.404 5.98c1.47.86 3.362.86 4.834.0l9.97-5.98c1.472-.86 2.102-2.45 2.102-4.168V12.28c0-1.72-.59-3.306-2.063-4.166z"/></svg></div></div></div></div><div id=wrapper><nav id=navbar><div class=navbar-wrapper><div class=container><div class=logo><a href=/><h2 class=logo-text>L.E.R Space</h2></a></div><div class=menu-extras><div class=menu-item><div class=open-search-form><a href id=searchbtn><i class=hc-search></i></a></div></div><div class=menu-item><div class=nav-toggle><a class=menu-toggle href=#><div class=hamburger><div class=hamburger-box><div class=hamburger-inner></div></div></div></a></div></div></div><div id=navigation><ul class="navigation-menu nav"><li class=menu-item><a href=/>Home</a><li class=menu-item><a href=/about>About</a><li class=menu-item><a href=/posts/1>Blog</a><li class=menu-item><a href=/links>Links</a><li class=menu-item><a href=/contact>Contact</a><li class=menu-item><a href=/projects>Software</a><li class=menu-item><a href=/cos>Cosplay AE</a><li class=menu-item><a href=/sheets>Sheets</a><li class=menu-item><a href=/archive>Archive</a><li class="menu-item-has-children last-elements"><a href=https://rongyi.blog target=_blank><i class=hc-globe></i></a><ul class=submenu><li><a href=https://rongyi.blog target=_blank>简体中文</a><li><a href=https://en.rongyi.blog target=_blank>English</a></ul></ul></div></div></div></nav><section class="page-title parallax-section"><div class=row-parallax-bg><div class=parallax-wrapper><div class=parallax-bg><img src=/media/posts/macandnotebook.jpg alt></div></div><div class=parallax-overlay></div></div><div class=centrize><div class=v-center><div class=container><div class=single-post-info><h6><span><i class=hc-clock></i>Posted on</span>
<span class=post-time>October 7, 2016</span>
<span>in <a href=/category/Linux.html>Linux</a></span></h6><div class="title text-center"><h1>Closer Look to WSL</h1></div><div class=post-author><img src=/media/author.jpg alt><a href=#>by LER0ever</a></div></div></div></div></div></section><section><div class=container><div class=row><div class=col-md-8><article class=post-single><div class=post-body><h2 id=the-background>The Background</h2><p>Back in Windows 2000 time, Windows is shipped with a POSIX subsystem and even a OS/2 subsystem for software compatibility for those two OS&rsquo;s. Below is a picture from the <a href="https://www.microsoft.com/resources/documentation/windowsnt/4/workstation/reskit/en-us/os2comp.mspx?mfr=true">msdn of NT workstation.</a><br><img src=https://www.microsoft.com/resources/documentation/windowsnt/4/workstation/reskit/en-us/images/xwraa02.gif alt="POSIX and OS/2 subsystem"><p>And the POSIX subsystem turns into SUA(Subsystem for Unix Application) as Microsoft released Windows Vista, and gets mature in Windows 7 / Windows Server 2008 (Picture from <a href=https://blogs.msdn.microsoft.com/sfu/2007/05/01/unix-interoperability-and-windows-vista/>MSDN 2007</a>)<p><img src=https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Components.PostAttachments/00/02/36/14/25/p5fig-1.JPG alt=SUA><h2 id=wsl-on-windows-10>WSL on Windows 10</h2><h4 id=a-few-terms-on-windows>A few terms on windows</h4><h6 id=windows-user-mode>Windows User Mode</h6><p>A CPU mode that provides isolation and protection for normal application so that even if one program crashes, no other programs will be affect.<h6 id=windows-kernel-mode>Windows Kernel Mode</h6><p>The CPU mode used by core components of system kernel (like hardware drivers) for interaction with hardware.<h6 id=windows-nt-kernel>Windows NT Kernel</h6><p>NT kernel separates the APIs that program can call and the system kernel, so that Windows NT supports multiple subsystem (Win32, OS/2, POSIX).<h6 id=pico-process>Pico Process</h6><p>Originally part of <a href=http://research.microsoft.com/en-us/projects/drawbridge/>DrawBridge project</a>. It provides a lightweight way to run an (linux) application in an isolated environment. No operating system kernel or service needed. All the system calls are handled by Pico driver.<h4 id=how-wsl-works>How WSL works</h4><h6 id=when-windows-10-starts>When Windows 10 starts</h6><p>It loads two more <code>.sys</code> file, <code>lxss.sys</code> and <code>lxcore.sys</code>, to NT kernel.<br><br><h6 id=after-user-types-bash-exe>After user types <code>bash.exe</code></h6><p>The LX Session Manager Service starts. This service is essential for communicating between bash.exe and Linux Elf64 binary.<br><br><h6 id=when-a-linux-program-starts>When a Linux program starts</h6><p>The Linux process starts as a Pico process in Windows NT User Mode<br><br><h4 id=lxss-system-calls>LXSS System Calls</h4><h6 id=lxcore-sys-and-lxss-sys>lxcore.sys and lxss.sys</h6><p>These to system files are responsible for intercepting all linux syscalls and translating them to Windows NT kernel instructions.<br><br><h6 id=fork>Fork</h6><pre><code class=language-python># Simple Fork Bomb
import os
while 1:
    os.fork()
</code></pre><p>There is no direct comparable call in Windows for Linux Fork(). So when the Linux process requires fork action, lxcore.sys intercept that call, prepare for the process replication and create multithread according to the program&rsquo;s requirements using NT kernel API.<br><br><h6 id=epoll>epoll</h6><p>Epoll is a syscall for I/O event notification. Under WSL, it&rsquo;s designed to merge into Win32 Event System for further handling.<br><br><h6 id=file-system>file system</h6><p>Windows provides VolFS for file compatibility with Linux file system. VolFS contains linux permission, symbolic link, case sensitive. DriveFS enables windows to read and write linux file system and also allow linux to see the windows volumn.<br><br><h6 id=wsl-components-picture-from-msdn>WSL Components, picture from MSDN</h6><p><img src=https://msdnshared.blob.core.windows.net/media/2016/04/LXSS-diagram-1024x472.jpg alt="WSL Components"></div><hr><div class=post-tags><a href=/tags/Linux.html>Linux</a> <a href=/tags/WSL.html>WSL</a></div></article></div><div class="col-md-3 col-md-offset-1"><div id=sidebar><div class=widget><h5>Search</h5><form class=searchform action=/><input class=form-control type=search required name=s placeholder="Tap or double `Alt` to search ..." id=searchbox></form></div><div class=widget><h5>Table of Contents</h5><div class=textwidget><p><a href=#The%20Background><i class=hc-code-working></i>&nbsp; The Background</a><br><a href=#WSL%20on%20Windows%2010><i class=hc-code-working></i>&nbsp; WSL on Windows 10</a><br></div></div><div class=widget><h5>Recent Posts</h5><ul><li><a href=/2017/3/25/libreplanet-2017.html>LibrePlanet 2017 @ MIT</a><li><a href=/2016/11/19/rust-code-style.html>Rust Coding Style</a><li><a href=/2016/10/7/wsl-tech.html>Closer Look to WSL</a><li><a href=/2016/10/4/using-wsl.html>Using and Customizing WSL</a><li><a href=/2016/8/5/welcome.html>About this New Site</a><li><a href=/2016/8/5/lumos.html>Lumos Static Site Generator</a><li><a href=/2016/3/11/alphago-intro-dl.html>AlphaGo Tech 2 - Deep Learning</a><li><a href=/2016/3/11/hhcm-mariadb-acc-php.html>HHVM&#43;MariaDB make PHP faster</a><li><a href=/2016/3/10/alphago-intro-mcts.html>AlphaGo Tech 1 - MCTS</a><li><a href=/2015/1/22/simple-cnn.html>Simple CNNs</a></ul></div><div class=widget><h5>Categories</h5><a href=/category/Algorithms.html><i class=hc-albums></i>&nbsp; Algorithms</a>(2)<br><a href=/category/Artificial%20Intelligence.html><i class=hc-albums></i>&nbsp; Artificial Intelligence</a>(1)<br><a href=/category/Conferences.html><i class=hc-albums></i>&nbsp; Conferences</a>(1)<br><a href=/category/Deep%20Learning.html><i class=hc-albums></i>&nbsp; Deep Learning</a>(2)<br><a href=/category/Go.html><i class=hc-albums></i>&nbsp; Go</a>(1)<br><a href=/category/Linux.html><i class=hc-albums></i>&nbsp; Linux</a>(2)<br><a href=/category/Rust.html><i class=hc-albums></i>&nbsp; Rust</a>(1)<br><a href=/category/Website.html><i class=hc-albums></i>&nbsp; Website</a>(3)<br></div><div class=widget><h5>Popular Tags</h5><div class=tagcloud><a href=/tags/AlphaGo.html style=font-size:8pt><i class=hc-pricetag></i>&nbsp; AlphaGo</a>
<a href=/tags/CNNs.html style=font-size:8pt><i class=hc-pricetag></i>&nbsp; CNNs</a>
<a href=/tags/Conferences.html style=font-size:8pt><i class=hc-pricetag></i>&nbsp; Conferences</a>
<a href=/tags/Free%20Software.html style=font-size:8pt><i class=hc-pricetag></i>&nbsp; Free Software</a>
<a href=/tags/Linux.html style=font-size:8pt><i class=hc-pricetag></i>&nbsp; Linux</a>
<a href=/tags/Lumos.html style=font-size:8pt><i class=hc-pricetag></i>&nbsp; Lumos</a>
<a href=/tags/Rust.html style=font-size:8pt><i class=hc-pricetag></i>&nbsp; Rust</a>
<a href=/tags/WSL.html style=font-size:8pt><i class=hc-pricetag></i>&nbsp; WSL</a></div></div></div></div></div></div></section><section id=comment><section class=grey-bg><div class=container><div id=disqus_thread></div><script>(function(){var d=document,s=d.createElement('script');s.src='//l-e-r-space.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments
powered by Disqus.</a></noscript></div></section></section><footer id=footer><div class=footer-widgets><div class=container><div class=row><div class="col-md-3 col-sm-6"><div class=widget><figure class="footer-logo mb-15"><p class=footer-logo-text>L.E.R Space</figure><div class=textwidget><p><img src=/media/misc/uw-crest.svg width=20 alt>
UW-Madison<br>2405 Hill Waters<br>1200 Observatory Drive<br>Madison, WI 53706-1212<p>etasry@gmail.com<br>+1 608-504-1266</div></div></div><div class="col-md-2 col-sm-6"><div class=widget><h5>Pages</h5><div class=menu-footer><ul><li><a href=/about.html>About</a><li><a href=/contact.html>Contact</a><li><a href=/projects.html>Software</a><li><a href=/sheets.html>Sheets</a><li><a href=/posts/1>Blog</a></ul></div></div></div><div class="col-md-2 col-sm-6"><div class=widget><h5>Meta</h5><div class=menu-footer><ul><li><a href=/feed.xml>RSS Feed</a><li><a href=/sitemap.xml>Sitemap</a><li><a href=/portus.html>Portus Status</a><li><a href=/license.html>Legal Stuff</a></ul></div></div></div><div class="col-md-5 col-sm-6"><div class=widget><h5>Site Info</h5><div class=menu-footer><p>Proudly powered by <b>my</b> <a href=/portus.html>Portus Engine 1.3.1</a><p>Deployed with <b>[everette@LER0ever-T460P-Manjaro]</b><p>Hosted on <b>Netlify</b> and <b>Hostker</b><p>Site content licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en target=_blank>Creative Common BY-NC-ND 4.0<img style=height:20px src=/media/footer/by-nc-nd.svg></a></div></div></div></div></div></div><div class=footer-copy><div class=container><div class=row><div class=col-sm-6><ul class=social-list><li class=social-item-linkedin><a target=_blank href=http://www.linkedin.com/in/LER0ever/><i class=hc-linkedin></i></a><li class=social-item-facebook><a target=_blank href=https://www.facebook.com/LER0ever><i class=hc-facebook></i></a><li class=social-item-twitter><a target=_blank href=https://twitter.com/LER0ever><i class=hc-twitter></i></a><li class=social-item-github><a target=_blank href=https://github.com/LER0ever><i class=hc-github></i></a><li class=social-item-instagram><a target=_blank href=https://instagram.com/LER0ever><i class=hc-instagram></i></a></ul></div><div class=col-sm-6><div class=copy-text><p>Copyright © 2014 - 2017 LER0ever. All Rights Reserved.</div></div><div id=toTop><i class=hc-arrow-dropup></i></div></div></div></div></footer></div><div class=search-tool style=position:fixed;top:0;bottom:0;left:0;right:0;opacity:.95;background-color:#111;z-index:9999;display:none><input class="form-control search-content" id=search-content style=position:fixed;top:60px placeholder="文章标题 分类 标签 (L.E.R Space 站内搜索)"><div style=position:fixed;top:16px;right:16px><img src=/search/img/close.png id=close-btn></div></div><script src=/js/jquery.js></script><script src=/js/bundle.js></script><script src=/js/SmoothScroll.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script src=/search/js/search.js></script><script src=/search/js/bootstrap3-typeahead.min.js></script><script src=/js/main.js></script><script>if(navigator.serviceWorker){navigator.serviceWorker.register('/js/sw.js').then(function(registration){}).catch(function(err){});}</script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-81922310-1','auto');ga('send','pageview');</script><script async src=//www.google-analytics.com/analytics.js></script>